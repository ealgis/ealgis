<!DOCTYPE html -->
<html>
<head>
  <title>Vector tiles</title>
  <link rel="stylesheet" href="https://openlayers.org/en/v4.1.1/css/ol.css" type="text/css">
  <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
  <!--<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>-->
  <!--<script src="https://openlayers.org/en/v3.20.1/build/ol.js"></script>-->
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.20.1/ol-debug.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.1.1/ol-debug.js"></script>
  <!--<link rel="stylesheet" href="ol.css">-->
  <style>
    html, body {
      font-family: sans-serif;
      width: 100%;
    }
    .map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map" class="map"></div>
  <script>

  // var style_black = new ol.style.Style({
  //   fill: new ol.style.Fill({
  //     color: '#ADD8E6'
  //   }),
  //   stroke: new ol.style.Stroke({
  //     color: '#000000',
  //     width: 1
  //   })
  // });
  // var style_blue = new ol.style.Style({
  //   fill: new ol.style.Fill({
  //     color: '#ADD8E6'
  //   }),
  //   stroke: new ol.style.Stroke({
  //     color: '#FF0000',
  //     width: 1
  //   })
  // });
  
  var styleConfig = [{
    name: "red",
    colour: "#E61919"
  },{
    name: "orange",
    colour: "#E6A219"
  },{
    name: "green",
    colour: "#A2E619"
  },{
    name: "light_green",
    colour: "#19E619"
  },{
    name: "aqua_green",
    colour: "#19E6A2"
  },{
    name: "blue",
    colour: "#19A2E6"
  }]

  var styles = [];
  for(var i = 0; i < styleConfig.length; i++) {
    var style = styleConfig[i];

    styles[style["name"]] = new ol.style.Style({
      fill: new ol.style.Fill({
        color: style["colour"]
      }),
      stroke: new ol.style.Stroke({
        color: style["colour"],
        width: 1
      })
    });
  }

  function simpleStyle(feature, resolution) {
    // console.log(feature);

    return new ol.style.Style({
        // fill: new ol.style.Fill({
        //     color: `#E6A219`,
        // }),
        stroke: new ol.style.Stroke({
            color: `#FF0000`,
            width: 5,
        }),
    });

    return styles["blue"];

    q = feature.get("q");
    
    if(q < 0) {
      return styles["red"];
    } else if(q < 7.5) {
      return styles["orange"];
    } else if(q < 15) {
      return styles["green"];
    } else if(q < 22.5) {
      return styles["light_green"];
    } else if(q < 30) {
      return styles["aqua_green"];
    } else {
      return styles["blue"];
    }
  }

  // var osm = new ol.layer.Tile({
  //   source: new ol.source.OSM()
  // });

  var key = 'pk.eyJ1Ijoia2VpdGhtb3NzIiwiYSI6IjkxMTViNjcxN2U5ZDBjMTYzYzY2MzQwNTJkZjM1NGFkIn0.HS40UI-OD5lQWBxUCZOwZg';
  var mapbox = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://api.mapbox.com/styles/v1/keithmoss/citje9al5004f2ipg4tc3neyi/tiles/256/{z}/{x}/{y}?access_token=' + key
    })
  });

  var layer1 = 'EALGIS:93493a38'; // SA4s Only
  var layer2 = 'EALGIS:0a8f9ac7'; // Carers per SA1
  var projection_epsg_no = '900913';
  var format = "pbf";
  // var format = "geojson";
  // var format = "topojson";
  var map = new ol.Map({
    target: 'map',
    view: new ol.View({
        // center: ol.proj.transform([115.9, -32], 'EPSG:4326', 'EPSG:900913'),

        // Perth
        center: ol.proj.transform([115.8903595001871, -31.959422712019233], 'EPSG:4326', 'EPSG:900913'),
        zoom: 13

        // Tassie
        // center: ol.proj.transform([147.6048762881278, -42.13371054774628], 'EPSG:4326', 'EPSG:900913'),
        // zoom: 7

        // center: ol.proj.transform([135, -27], 'EPSG:4326', 'EPSG:900913'),
        // zoom: 4
    }),
    layers: [
        // osm,
        mapbox,

        new ol.layer.VectorTile({
            style: simpleStyle,
            
            renderMode: 'hybrid',
            // preload: Infinity,
            opacity: 0.6,

            // http://openlayers.org/en/latest/apidoc/ol.html#.Extent
            // extent: ol.proj.transformExtent([96.81694140800035, -43.740509602057664, 159.10921900799997, -9.142175976703564], 'EPSG:4326', 'EPSG:900913'),

            source: new ol.source.VectorTile({
                // tilePixelRatio: 1, // oversampling when > 1
                tilePixelRatio: 16,
                tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
                format: new ol.format.MVT({featureClass: ol.Feature}),
                // overlaps: false,
                // cacheSize: 256,
                // url: 'https://gs{1-4}.localhost:8443/geoserver/gwc/service/tms/1.0.0/' + layer2 + '@EPSG%3A'+projection_epsg_no+'@' + format + '/{z}/{x}/{-y}.' + format
                // url: "http://localhost:8123/mvt/v1/sa4_2011_aust_pow_view/{z}/{x}/{y}?geom_column=geom_3857_z11&columns=gid,sa4_name"
                url: "http://localhost:8000/api/0.1/maps/201/tiles.json?layer=3c7592b8&z={z}&x={x}&y={y}&format=pbf"
            })
        })

        /*new ol.layer.VectorTile({
            style: simpleStyle,
            
            renderMode: 'hybrid',
            // preload: Infinity,
            opacity: 0.6,

            // http://openlayers.org/en/latest/apidoc/ol.html#.Extent
            // extent: ol.proj.transformExtent([96.81694140800035, -43.740509602057664, 159.10921900799997, -9.142175976703564], 'EPSG:4326', 'EPSG:900913'),

            source: new ol.source.VectorTile({
                // tilePixelRatio: 1, // oversampling when > 1
                tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
                format: new ol.format.GeoJSON({defaultDataProjection: "EPSG:4326"}),
                // overlaps: false,
                // cacheSize: 256,
                // url: 'https://gs{1-4}.localhost:8443/geoserver/gwc/service/tms/1.0.0/' + layer2 + '@EPSG%3A'+projection_epsg_no+'@' + format + '/{z}/{x}/{-y}.' + format
                url: "http://localhost:8123/mvt/v1/sa2_2011_aust_pow/{z}/{x}/{y}?geom_column=geom_3857&columns=gid,sa2_name"
            })
        })*/

        /*new ol.layer.VectorTile({
            style: simpleStyle,
            
            renderMode: 'hybrid',
            // preload: Infinity,
            opacity: 0.6,

            // http://openlayers.org/en/latest/apidoc/ol.html#.Extent
            extent: ol.proj.transformExtent([96.81694140800035, -43.740509602057664, 159.10921900799997, -9.142175976703564], 'EPSG:4326', 'EPSG:900913'),

            source: new ol.source.VectorTile({
                tilePixelRatio: 1, // oversampling when > 1
                tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
                format: function() {
                  if(format == "pbf") {
                    return new ol.format.MVT();
                  } else if(format == "geojson") {
                    return new ol.format.GeoJSON({defaultDataProjection: "EPSG:900913"});
                  } else if(format == "topojson") {
                    return new ol.format.TopoJSON({defaultDataProjection: "EPSG:900913"});
                  }
                }(),
                overlaps: false,
                cacheSize: 256,
                url: 'https://gs{1-4}.localhost:8443/geoserver/gwc/service/tms/1.0.0/' + layer2 + '@EPSG%3A'+projection_epsg_no+'@' + format + '/{z}/{x}/{-y}.' + format
            })
        }),

        new ol.layer.VectorTile({
            style: function() {
              return new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: '#006DFF',
                  width: 3
                })
              });
            },
            
            renderMode: 'hybrid',
            // preload: Infinity,

            // http://openlayers.org/en/latest/apidoc/ol.html#.Extent
            extent: ol.proj.transformExtent([96.81694140800035, -43.740509602057664, 159.10921900799997, -9.142175976703564], 'EPSG:4326', 'EPSG:900913'),

            source: new ol.source.VectorTile({
                tilePixelRatio: 1, // oversampling when > 1
                tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
                format: function() {
                  if(format == "pbf") {
                    return new ol.format.MVT();
                  } else if(format == "geojson") {
                    return new ol.format.GeoJSON({defaultDataProjection: "EPSG:900913"});
                  } else if(format == "topojson") {
                    return new ol.format.TopoJSON({defaultDataProjection: "EPSG:900913"});
                  }
                }(),
                overlaps: false,
                cacheSize: 256,
                url: 'https://gs{1-4}.localhost:8443/geoserver/gwc/service/tms/1.0.0/' + layer1 + '@EPSG%3A'+projection_epsg_no+'@' + format + '/{z}/{x}/{-y}.' + format
            })
        }),*/

        /*new ol.layer.Tile({
        //   extent: [-13884991, 2870341, -7455066, 6338219],
          opacity: 0.6,
          // preload: Infinity,
          source: new ol.source.TileWMS({
            // url: '/geoserver/wms',
            urls: [
              'https://gs1.localhost:8443/geoserver/wms',
              'https://gs2.localhost:8443/geoserver/wms',
              'https://gs3.localhost:8443/geoserver/wms',
              'https://gs4.localhost:8443/geoserver/wms',
            ],
            params: {'LAYERS': layer1, 'TILED': true, 'SRS': 'EPSG:900913'},
            serverType: 'geoserver',
            cacheSize: 256,
          })
        }),*/


        /*new ol.layer.Tile({
          opacity: 0.6,
          // preload: Infinity,
          source: new ol.source.TileWMS({
            urls: [
              'https://gs1.localhost:8443/geoserver/gwc/service/wms',
              'https://gs2.localhost:8443/geoserver/gwc/service/wms',
              'https://gs3.localhost:8443/geoserver/gwc/service/wms',
              'https://gs4.localhost:8443/geoserver/gwc/service/wms',
            ],
            params: {'LAYERS': layer1, 'TILED': true, 'SRS': 'EPSG:900913'},
            serverType: 'geoserver',
            cacheSize: 256,
          })
        }),
        new ol.layer.Tile({
          opacity: 0.6,
          // preload: Infinity,
          source: new ol.source.TileWMS({
            urls: [
              'https://gs1.localhost:8443/geoserver/gwc/service/wms',
              'https://gs2.localhost:8443/geoserver/gwc/service/wms',
              'https://gs3.localhost:8443/geoserver/gwc/service/wms',
              'https://gs4.localhost:8443/geoserver/gwc/service/wms',
            ],
            params: {'LAYERS': layer2, 'TILED': true, 'SRS': 'EPSG:900913'},
            serverType: 'geoserver',
            cacheSize: 256,
          })
        })*/

        // new ol.layer.Image({
        //   source: new ol.source.ImageWMS({
        //     url: 'https://localhost:8443/geoserver/EALGIS/wms',
        //     params: {'LAYERS': layer1},
        //     serverType: 'geoserver'
        //   })
        // })
    ]
  });

  /*var select = new ol.interaction.Select();
  map.addInteraction(select);
  select.on('select', function(e) {
    console.log(e);
    // console.log(e.target.getFeatures().getLength() +
    //             ' selected features (last operation selected ' + e.selected.length +
    //             ' and deselected ' + e.deselected.length + ' features)');
    console.log(e.target.getFeatures());
  })*/

  map.on("click", function(evt) {
    map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
      // const layerProps = layer.getProperties().properties
      // const featureProps = feature.getProperties()

      console.log(feature.getProperties(), feature.getProperties().geometry.getExtent());
    });
  });    
  </script>
</body>
</html>