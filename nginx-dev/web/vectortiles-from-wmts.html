<!DOCTYPE html>
<html>
  <head>
    <title>Mapbox Vector Tiles</title>
    <!--<link rel="stylesheet" href="http://openlayers.org/en/v3.18.2/css/ol.css" type="text/css">-->
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <!--<script src="http://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.19.1/ol.js"></script>
    <script src="https://openlayers.org/en/v3.19.1/examples/resources/mapbox-streets-v6-style.js"></script>
    <style>
      .map {
        background: #f8f4f0;
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script>
        /* eslint-disable openlayers-internal/no-unused-requires */
        fetch('/geoserver/gwc/service/wmts?REQUEST=GetCapabilities').then(function(response) {
            return response.text();
        }).then(function(text) {
            // https://2016.foss4g-na.org/sites/default/files/slides/Foss4G_VTs_FINAL.pdf
            // c.f. http://suite.opengeo.org/docs/latest/dataadmin/vectortiles/index.html
            var caps = new ol.format.WMTSCapabilities().read(text);
            var wmts = new ol.source.WMTS(
                ol.source.WMTS.optionsFromCapabilities(caps, {
                    // layer: 'test:BuildingFootprintsPerthCBD',
                    // layer: 'Test:ste_2011_aust_pow_3857',
                    layer: 'Test:sa4_2011_aust_pow_3857',
                    matrixSet: 'EPSG:900913',
                    format: 'application/x-protobuf;type=mapbox-vector'
                    // format: 'application/json;type=topojson'
                    // format: 'application/json;type=geojson'
                })
            );
            console.log(wmts.getTileGrid());

            var map = new ol.Map({
                layers: [
                    mapboxSource = new ol.layer.VectorTile({
                        source: new ol.source.VectorTile({
                            attributions: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ' +
                                '© <a href="http://www.openstreetmap.org/copyright">' +
                                'OpenStreetMap contributors</a>',
                            format: new ol.format.MVT(),
                            tileGrid: ol.tilegrid.createXYZ({maxZoom: 22}),
                            tilePixelRatio: 16,
                            url: 'https://{a-d}.tiles.mapbox.com/v4/mapbox.mapbox-streets-v6/' +
                                '{z}/{x}/{y}.vector.pbf?access_token=' + 'pk.eyJ1Ijoia2VpdGhtb3NzIiwiYSI6ImNpcjV1NXJteDAwOXBnY25mMmVmY2drZDgifQ.P1RCcUjhO19Wlv2Gl-ruSw'
                        }),
                        style: createMapboxStreetsV6Style()
                    }),
                    new ol.layer.VectorTile({
                        source: new ol.source.VectorTile({
                            format: new ol.format.MVT(),
                            // format: new ol.format.TopoJSON({defaultDataProjection: "EPSG:900913"}),
                            // format: new ol.format.GeoJSON({defaultDataProjection: "EPSG:3857"}),
                            tileUrlFunction: wmts.getTileUrlFunction(),
                            tileGrid: wmts.getTileGrid(),
                            // overlaps: false,
                        }),
                        // OSM Vector Tiles
                        // http://openlayers.org/en/latest/examples/osm-vector-tiles.html?q=vector+tiles
                        style: function(feature, resolution) {
                            return new ol.style.Style({
                                fill: new ol.style.Fill({
                                    color: '#ADD8E6'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: '#880000',
                                    width: 1
                                }),
                                // http://openlayers.org/en/latest/examples/vector-labels.html?q=label
                                // text: new ol.style.Text({
                                //     // textAlign: align,
                                //     // textBaseline: baseline,
                                //     // font: font,
                                //     // text: getText(feature, resolution, dom),
                                //     text: feature.get('MB_CODE11'),
                                //     // fill: new ol.style.Fill({color: fillColor}),
                                //     fill: new ol.style.Fill({color: "blue"}),
                                //     // stroke: new ol.style.Stroke({color: outlineColor, width: outlineWidth}),
                                //     // offsetX: offsetX,
                                //     // offsetY: offsetY,
                                //     // rotation: rotation
                                // })
                            });
                        }
                        // style: function(feature, resolution) {
                        //     return [
                        //         new ol.style.Style({
                        //             zIndex: 1,
                        //             stroke: new ol.style.Stroke({color: '#fff', width: 4})
                        //         }),
                        //         new ol.style.Style({
                        //             zIndex: 2,
                        //             stroke: new ol.style.Stroke({color: '#ddd', width: 3})
                        //         })
                        //     ];
                        // }
                    })
                ],
                target: 'map',
                view: new ol.View({
                    center: ol.proj.transform([115.9, -32], 'EPSG:4326', 'EPSG:3857'),
                    zoom: 12
                })
            });

            // var info = document.createElement('div');
            // var overlay = new ol.Overlay({element: info});
            // map.addOverlay(overlay);
            // map.on('pointermove', function(e) {
            //     var name = map.forEachFeatureAtPixel(e.pixel, function(feature) {
            //         return feature.get('MB_CODE11');
            //     });
            //     info.style.display = name ? '' : 'none';
            //     info.innerHTML = name;
            //     overlay.setPosition(e.coordinate);
            // });

            // ol.style.Fill, ol.style.Icon, ol.style.Stroke, ol.style.Style and
            // ol.style.Text are required for createMapboxStreetsV6Style()
        });
    </script>
  </body>
</html>