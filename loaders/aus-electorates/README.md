# EALGIS - Australian Electorate Boundaries

(To find out what EALGIS is, see https://github.com/ealgis/ealgis/)

(And if you're after our loader for the ABS's annual Australian Statistical Geography Standard (ASGS) releases of Commonwealth and State electoral divisions see https://github.com/ealgis/asgs/)

## Overview

This loader generates database schemas for Australian federal, state, and territory electoral boundaries.
When boundaries are updated, they will be added to this repository. Historical boundaries will continue to be available.

To contribute by adding new electoral boundaries to this repo, see the 'Adding new boundaries to the loader' section below.

## What you get

At the end of this process you'll have a set of PostgreSQL `.dump` files that you can load into your EALGIS database using the [`pg_restore` command-line tool](https://www.postgresql.org/docs/11/app-pgrestore.html). Each of these files represent a separate PostgreSQL schema that will live inside your EALGIS database.

**Tip:** There's nothing special about the schemas generated by this loader, or how the data is structured, so you can use them anywhere you like.

## Running the loader

Running the loader is as simple as:

```
docker-compose run dataloader /bin/bash
./load.sh
```

Four things happen when you run the loader:

1. A (temporary) PostgreSQL + PostGIS database called `ealgis` is created
2. Schemas are created for each grouping of boundaries in this repo (e.g. `au_federal_electorate_boundaries`, `au_wa_state_electorate_boundaries`, et cetera)
3. All of the spatial data files known to `recipe.py` are analysed and imported into their relevant schema
4. A series of PostgreSQL `.dump` files are generated - one for each schema.

At the end of the load process you'll find the PostgreSQL `.dump` files in a new `tmp` directory at the root of this repo.

```
tmp/
    au_federal_electorate_boundaries.dump
    au_nsw_state_electorate_boundaries.dump
    au_nt_state_electorate_boundaries.dump
    au_qld_state_electorate_boundaries.dump
    au_sa_state_electorate_boundaries.dump
    au_vic_state_electorate_boundaries.dump
    au_wa_state_electorate_boundaries.dump
```

### Loading the data into EALGIS

The `.dump` files created by this loader are intended to completely replace any existing electoral boundary schemas in your EALGIS database. So, if you're re-running the loader to add new boundaries, remember to `DROP SCHEMA schema_name CASCADE;` before running `pg_restore`.

**Tip:** If you have a multiprocessor machine, `pg_restore` comes with an optional [--jobs](https://www.postgresql.org/docs/11/app-pgrestore.html) flag to use multiple concurrent processes/threads to dramatically reduce the time taken to load the data.

#### If you're using a Dockerised EALGIS install

Drop your `.dump` files in the `loaders` directory of your EALGIS install. If necessary, add the `loaders` directory to the `datastore` container in your `docker-compose.yml` file:

```yaml
volumes:
    - ./loaders:/app
```

Then run:

```
docker exec -it ealgis_datastore_1 sh
pg_restore --host=localhost --username=postgres --dbname=datastore /app/sample.dump
```

#### If you're using RDS or some other flavour of standalone PostgreSQL database

Then just check that the version of `pg_restore` installed locally matches the major version of your PostgreSQL database, work out your connection details, and run `pg_restore` for each of the `.dump` files as above.

**Tip:** See IBM's guide [Install only the necessary tools for a lean, mean PostgreSQL client machine](https://www.ibm.com/cloud/blog/new-builders/postgresql-tips-installing-the-postgresql-client) to find out how to install `pg_restore` on your machine.

### As your last steps

1. Run [`VACUUM ANALYZE;`](https://www.postgresql.org/docs/11/sql-vacuum.html) against your EALGIS database
2. Restart your EALGIS `web` container so it picks up the newly refreshed schemas

And you're done!

## Adding new boundaries to the loader

Adding new electoral boundaries to this repo is a two-step process - and PRs are very welcome!

### 1. Get the data

This loader currently supports data in Shapefiles, MID/MIF, and KML (godsforbid).

Once you've found the spatial data from the relevant electoral commission simply:

1. Zip up the data (the data files themselves - not the folder they're in)
2. Give it a sensible filename
3. Create a new directory for it (usually named after the year the boundaries were declared)

**Tip:** If the electoral commission supplies any metadata documents (PDFs, DOCX, et cetera) with the boundaries please ensure those get committed alongside the data as well.

**Important:** Be sure to add a `README.md` file containg the URL where you found the boundaries, and any notes about what you did to repackage or change the files from the originals provided by the electoral commission. (As a principle, there should be sufficient detail in your notes to allow someone else to reproduce what you did with no other knowledge.)

#### Adding a new spatial data format

The loader uses GDAL's venerable [ogr2ogr](https://gdal.org/programs/ogr2ogr.html) tool to load spatial data into PostgreSQL - so there's practically no limit on the data formats you could use. Additional formats can be added by creating a new `GeoDataLoader` class in [ealgis-common](https://github.com/ealgis/ealgis/blob/master/django/ealgis/common/loaders.py).

### 2. Add your boundaries to recipe.py

Find the relevant section in `recipe.py` and add a new tuple for your boundaries. For example:

```python
('wa_2011_lc', 'Western Australian Legislative Council 2011', 'WA/2011/waec2011_final_boundaries_lc.zip', load_shapefile, (WGS84,))
```

| Parameter                                     | Description                                                                                                                                                       |
| --------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `wa_2011_lc`                                  | The name of the database table that your boundaries will be loaded into.                                                                                          |
| `Western Australian Legislative Council 2011` | This is the human-readable name that EALGIS users will see.                                                                                                       |
| `WA/2011/waec2011_final_boundaries_lc.zip`    | This is the relative path to the ZIP file in this repo containing the spatial data.                                                                               |
| `load_shapefile`                              | This is the name of the loader function for the spatial data format the boundaries are stored in. Supported loaders: `load_shapefile`, `load_mapinfo`, `load_kml` |
| `(WGS84,)`                                    | This tells the loader which coordinate reference system the data was provided in. (This should be in the metadata.)                                               |
